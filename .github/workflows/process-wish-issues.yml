name: Process Wish Issues

on:
  issues:
    types: [opened, labeled]
  schedule:
    # æ¯å¤©UTC 00:00è¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´8:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process-wishes:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'wish') || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Fetch and Process Wishes from Issues
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Fetching wishes from GitHub Issues..."

        # åˆ›å»ºå¤„ç†è„šæœ¬
        cat > process-issues.js << 'EOF'
        const https = require('https');
        const fs = require('fs');

        const REPO_OWNER = process.env.GITHUB_REPOSITORY.split('/')[0];
        const REPO_NAME = process.env.GITHUB_REPOSITORY.split('/')[1];
        const TOKEN = process.env.GITHUB_TOKEN;

        function makeRequest(options) {
          return new Promise((resolve, reject) => {
            const req = https.request(options, (res) => {
              let data = '';
              res.on('data', chunk => data += chunk);
              res.on('end', () => {
                try {
                  resolve(JSON.parse(data));
                } catch (e) {
                  resolve(data);
                }
              });
            });
            req.on('error', reject);
            req.end();
          });
        }

        function parseIssueBody(body) {
          const featureMatch = body.match(/## åŠŸèƒ½éœ€æ±‚\s*([\s\S]*?)(?=##|$)/);
          const productMatch = body.match(/## åŒç±»äº§å“\s*([\s\S]*?)(?=##|$)/);
          const submitterMatch = body.match(/## æäº¤è€…\s*([\s\S]*?)(?=##|$)/);

          return {
            featureRequest: featureMatch ? featureMatch[1].trim() : '',
            similarProduct: productMatch ? productMatch[1].trim() : '',
            submitter: submitterMatch ? submitterMatch[1].trim() || 'Anonymous' : 'Anonymous'
          };
        }

        function filterContent(text) {
          const forbiddenWords = ['spam', 'å¹¿å‘Š', 'test123', 'åƒåœ¾'];
          const lowerText = text.toLowerCase();
          return !forbiddenWords.some(word => lowerText.includes(word)) &&
                 text.length >= 10 &&
                 text.length <= 500;
        }

        async function main() {
          // è·å–æ‰€æœ‰å¸¦ wish å’Œ pending-review æ ‡ç­¾çš„ Issues
          const options = {
            hostname: 'api.github.com',
            path: `/repos/${REPO_OWNER}/${REPO_NAME}/issues?labels=wish,pending-review&state=open`,
            method: 'GET',
            headers: {
              'User-Agent': 'GitHub-Actions',
              'Authorization': `token ${TOKEN}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          };

          const issues = await makeRequest(options);
          console.log(`Found ${issues.length} pending wish issues`);

          if (issues.length === 0) {
            console.log('No pending wishes to process');
            return;
          }

          // è¯»å–ç°æœ‰çš„ wishes.json
          let existingWishes = [];
          try {
            const data = fs.readFileSync('public/wishes.json', 'utf8');
            existingWishes = JSON.parse(data);
          } catch (error) {
            console.log('No existing wishes found');
          }

          const newWishes = [];
          const processedIssues = [];

          for (const issue of issues) {
            const parsed = parseIssueBody(issue.body || '');

            if (!parsed.featureRequest || !filterContent(parsed.featureRequest)) {
              console.log(`Skipping issue #${issue.number}: Failed content filter`);
              continue;
            }

            const wish = {
              id: `issue-${issue.number}-${Date.now()}`,
              featureRequest: parsed.featureRequest,
              similarProduct: parsed.similarProduct,
              submitter: parsed.submitter,
              isImplemented: false,
              timestamp: issue.created_at,
              status: 'approved',
              source: `issue-${issue.number}`
            };

            newWishes.push(wish);
            processedIssues.push(issue.number);
          }

          if (newWishes.length > 0) {
            // åˆå¹¶å¹¶ä¿å­˜
            const allWishes = [...newWishes, ...existingWishes];
            fs.writeFileSync('public/wishes.json', JSON.stringify(allWishes, null, 2));
            console.log(`Added ${newWishes.length} new wishes`);

            // ä¿å­˜å¤„ç†çš„ Issue ç¼–å·
            fs.writeFileSync('processed-issues.txt', processedIssues.join(','));
          } else {
            console.log('No new wishes to add');
          }
        }

        main().catch(console.error);
        EOF

        # è¿è¡Œå¤„ç†è„šæœ¬
        node process-issues.js

    - name: Close Processed Issues
      if: hashFiles('processed-issues.txt') != ''
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ -f "processed-issues.txt" ]; then
          IFS=',' read -ra ISSUES <<< "$(cat processed-issues.txt)"
          for issue_num in "${ISSUES[@]}"; do
            echo "Closing and labeling issue #$issue_num"

            # æ·»åŠ  approved æ ‡ç­¾å¹¶ç§»é™¤ pending-review
            gh issue edit "$issue_num" --add-label "approved" --remove-label "pending-review"

            # å…³é—­ Issue å¹¶æ·»åŠ è¯„è®º
            gh issue close "$issue_num" --comment "âœ… æ‚¨çš„æ„¿æœ›å·²å®¡æ ¸é€šè¿‡å¹¶æ·»åŠ åˆ°è®¸æ„¿æ± ï¼æ„Ÿè°¢æ‚¨çš„åé¦ˆã€‚"
          done
        fi

    - name: Create Pull Request
      if: hashFiles('public/wishes.json') != ''
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "feat: ä» Issues è‡ªåŠ¨æ·»åŠ æ–°è®¸æ„¿"
        title: "ğŸ¯ è‡ªåŠ¨æ·»åŠ æ–°è®¸æ„¿"
        body: |
          ## ğŸ¤– è‡ªåŠ¨å¤„ç†è®¸æ„¿

          æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å«ä» Issues ä¸­å®¡æ ¸é€šè¿‡çš„æ–°æ„¿æœ›ã€‚

          ### å¤„ç†çš„ Issue
          æŸ¥çœ‹å·²å…³é—­çš„ Issues äº†è§£è¯¦æƒ…

          ### å®¡æ ¸è§„åˆ™
          - âœ… å†…å®¹é•¿åº¦åœ¨ 10-500 å­—ç¬¦ä¹‹é—´
          - âœ… è¿‡æ»¤ä¸å½“è¯æ±‡
          - âœ… æ ¼å¼æ ‡å‡†åŒ–
          - âœ… è‡ªåŠ¨å…³é—­å·²å¤„ç†çš„ Issues

          ---
          *æ­¤ PR ç”±è‡ªåŠ¨å®¡æ ¸ç³»ç»Ÿç”Ÿæˆ*
        branch: auto-wish-issues
        delete-branch: true
        labels: wishes, automated