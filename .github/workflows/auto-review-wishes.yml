name: Auto Review Wishes

on:
  schedule:
    # æ¯å¤©UTC 00:00è¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´8:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        if [ -f "package.json" ]; then
          npm install
        fi

    - name: Auto review wishes
      run: |
        echo "Starting automatic wish review process..."

        # åˆ›å»ºå®¡æ ¸è„šæœ¬
        cat > review-wishes.js << 'EOF'
        const fs = require('fs');

        function filterContent(text) {
          // ç®€å•çš„å†…å®¹è¿‡æ»¤è§„åˆ™
          const forbiddenWords = ['spam', 'å¹¿å‘Š', 'test', 'æµ‹è¯•'];
          const lowerText = text.toLowerCase();

          return !forbiddenWords.some(word => lowerText.includes(word)) &&
                 text.length >= 10 &&
                 text.length <= 500;
        }

        function formatWish(wish) {
          return {
            id: wish.id,
            featureRequest: wish.featureRequest.trim(),
            similarProduct: wish.similarProduct ? wish.similarProduct.trim() : '',
            submitter: wish.submitter || 'Anonymous',
            isImplemented: false,
            timestamp: wish.timestamp,
            status: 'approved'
          };
        }

        // è¯»å–ç°æœ‰çš„ wishes.json
        let existingWishes = [];
        try {
          const existingData = fs.readFileSync('public/wishes.json', 'utf8');
          existingWishes = JSON.parse(existingData);
          console.log(`Loaded ${existingWishes.length} existing wishes`);
        } catch (error) {
          console.log('No existing wishes found, starting fresh');
        }

        // æ¨¡æ‹Ÿå¤„ç†å¾…å®¡æ ¸çš„æ„¿æœ›ï¼ˆå®é™…åº”ç”¨ä¸­è¿™äº›æ•°æ®å¯èƒ½æ¥è‡ªå…¶ä»–æ¥æºï¼‰
        // è¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºä» Issuesã€API æˆ–å…¶ä»–æ•°æ®æºè·å–
        console.log('Auto-review process completed');
        console.log('Wishes filtered and formatted successfully');
        EOF

        # è¿è¡Œå®¡æ ¸è„šæœ¬
        node review-wishes.js

    - name: Check for updates
      id: check-updates
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å®¡æ ¸ç»“æœéœ€è¦æ›´æ–°
        if [ -f "review-results.json" ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "Found review results to process"
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "No updates needed"
        fi

    - name: Create PR if updates exist
      if: steps.check-updates.outputs.has_updates == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "Auto-update wishes from review process"
        title: "è‡ªåŠ¨å®¡æ ¸æ„¿æœ›æ›´æ–°"
        body: |
          ğŸ¤– **è‡ªåŠ¨å®¡æ ¸æ„¿æœ›æ›´æ–°**

          æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å«ç»è¿‡è‡ªåŠ¨å®¡æ ¸çš„æ„¿æœ›ã€‚

          ## å®¡æ ¸è§„åˆ™
          - âœ… å†…å®¹é•¿åº¦åœ¨ 10-500 å­—ç¬¦ä¹‹é—´
          - âœ… è¿‡æ»¤ä¸å½“è¯æ±‡
          - âœ… æ ¼å¼æ ‡å‡†åŒ–

          ## ç®¡ç†å‘˜æé†’
          è¯·ä»”ç»†å®¡æŸ¥æ¯ä¸ªæ„¿æœ›çš„å†…å®¹ï¼Œç¡®è®¤æ˜¯å¦åˆé€‚æ·»åŠ åˆ°æ­£å¼åˆ—è¡¨ä¸­ã€‚

          ---
          *æ­¤ PR ç”±è‡ªåŠ¨å®¡æ ¸ç³»ç»Ÿç”Ÿæˆ*
        branch: auto-wish-review
        delete-branch: true
        draft: false