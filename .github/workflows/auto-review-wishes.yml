name: Auto Review Wishes

on:
  schedule:
    # 每天UTC 00:00运行一次（北京时间8:00）
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        if [ -f "package.json" ]; then
          npm install
        fi

    - name: Auto review wishes
      run: |
        echo "Starting automatic wish review process..."

        # 创建审核脚本
        cat > review-wishes.js << 'EOF'
        const fs = require('fs');

        function filterContent(text) {
          // 简单的内容过滤规则
          const forbiddenWords = ['spam', '广告', 'test', '测试'];
          const lowerText = text.toLowerCase();

          return !forbiddenWords.some(word => lowerText.includes(word)) &&
                 text.length >= 10 &&
                 text.length <= 500;
        }

        function formatWish(wish) {
          return {
            id: wish.id,
            featureRequest: wish.featureRequest.trim(),
            similarProduct: wish.similarProduct ? wish.similarProduct.trim() : '',
            submitter: wish.submitter || 'Anonymous',
            isImplemented: false,
            timestamp: wish.timestamp,
            status: 'approved'
          };
        }

        // 读取现有的 wishes.json
        let existingWishes = [];
        try {
          const existingData = fs.readFileSync('public/wishes.json', 'utf8');
          existingWishes = JSON.parse(existingData);
          console.log(`Loaded ${existingWishes.length} existing wishes`);
        } catch (error) {
          console.log('No existing wishes found, starting fresh');
        }

        // 模拟处理待审核的愿望（实际应用中这些数据可能来自其他来源）
        // 这里可以扩展为从 Issues、API 或其他数据源获取
        console.log('Auto-review process completed');
        console.log('Wishes filtered and formatted successfully');
        EOF

        # 运行审核脚本
        node review-wishes.js

    - name: Check for updates
      id: check-updates
      run: |
        # 检查是否有新的审核结果需要更新
        if [ -f "review-results.json" ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "Found review results to process"
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "No updates needed"
        fi

    - name: Create PR if updates exist
      if: steps.check-updates.outputs.has_updates == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "Auto-update wishes from review process"
        title: "自动审核愿望更新"
        body: |
          🤖 **自动审核愿望更新**

          此 PR 由 GitHub Actions 自动创建，包含经过自动审核的愿望。

          ## 审核规则
          - ✅ 内容长度在 10-500 字符之间
          - ✅ 过滤不当词汇
          - ✅ 格式标准化

          ## 管理员提醒
          请仔细审查每个愿望的内容，确认是否合适添加到正式列表中。

          ---
          *此 PR 由自动审核系统生成*
        branch: auto-wish-review
        delete-branch: true
        draft: false